# C++评测引擎实现文档

## 引擎架构

我们实现了一个完整的评测引擎系统，其主要组件包括：

1. **评测引擎核心（JudgeEngine）**：负责代码编译、执行和结果比对的核心组件
2. **评测队列和线程管理**：实现异步评测，提高系统效率
3. **提交服务集成**：将评测引擎与现有的提交服务集成，实现完整的评测流程

## 关键技术点

### 1. 严格遵循C++11标准

- 编译命令使用 `g++ -std=c++11` 确保代码符合C++11标准
- 使用C++11特性如线程库、智能指针等提高代码质量

### 2. 安全沙箱实现

- 使用Unix系统调用（fork/exec）创建隔离的进程环境
- 使用资源限制（setrlimit）控制CPU时间和内存使用
- 重定向标准输入/输出/错误，防止程序影响主系统

### 3. 资源监控

- 使用wait4系统调用获取进程资源使用情况
- 精确测量CPU时间和内存使用
- 检测超时和超内存情况

### 4. 异步评测

- 使用线程安全的队列实现评测任务管理
- 创建独立的评测线程在后台处理评测任务
- 通过条件变量实现线程间同步

### 5. 异常处理

- 全面的错误检查和异常处理
- 针对各种异常情况提供详细的错误信息
- 确保系统在各种情况下都能稳定运行

## 评测流程详解

1. **提交处理**：
   - 用户提交代码
   - 系统保存提交记录并设置初始状态为"等待评测"
   - 将评测任务加入评测队列

2. **代码编译**：
   - 创建临时工作目录
   - 将源代码写入文件
   - 使用g++编译器（C++11标准）编译代码
   - 捕获编译错误并返回给用户

3. **测试执行**：
   - 对每个测试用例，创建新的进程执行用户程序
   - 重定向标准输入/输出
   - 设置资源限制（CPU时间和内存）
   - 监控程序执行情况

4. **结果判定**：
   - 比较程序输出与预期输出
   - 检查资源使用情况
   - 根据结果设置评测状态（通过、答案错误、超时等）

5. **结果汇总**：
   - 计算总得分和平均资源使用
   - 更新提交记录的评测结果
   - 清理临时文件

## 使用指南

使用评测引擎无需额外配置，提交代码后系统会自动进行评测。评测结果将在评测完成后显示在提交记录中。

## 扩展性

当前的评测引擎支持C++语言，系统设计允许轻松扩展支持其他编程语言：

1. 在JudgeEngine类中添加对应语言的编译和执行命令
2. 在Submission模型中添加语言枚举值
3. 在评测流程中处理新语言的特殊需求

## 限制和注意事项

1. 评测引擎需要在Unix/Linux环境下运行（使用了fork/exec等系统调用）
2. 需要g++编译器支持C++11标准
3. 为安全起见，评测应当在隔离的环境中运行
4. 大量并发评测可能需要更复杂的队列管理和资源控制

## 总结

我们实现的评测引擎是一个完整、安全、高效的系统，能够准确评测用户提交的C++代码，并提供详细的评测结果。通过异步设计，系统具有良好的响应性和可扩展性。

---

_注意：该评测引擎使用了Unix系统特性，仅适用于Linux/MacOS等Unix类操作系统。_ 